<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Chat Test</title>
</head>

<body>
  <h2>💬 Chat Test</h2>

  <div>
    <label>User ID:</label>
    <input id="userId" placeholder="Nhập userId của bạn" style="width:300px" />
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn">Disconnect</button>
  </div>

  <div style="margin-top:10px;">
    <label>Receiver ID:</label>
    <input id="receiverId" placeholder="Nhập userId người nhận" style="width:300px" />
    <br />
    <label>Message:</label>
    <input id="messageInput" placeholder="Nhập tin nhắn..." style="width:300px" />
    <button id="sendBtn">Send</button>
  </div>

  <h3>Status: <span id="status">Disconnected</span></h3>
  <pre id="logs" style="background:#f5f5f5;padding:10px;height:200px;overflow:auto;"></pre>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    let socket;
    const logsEl = document.getElementById('logs');
    const statusEl = document.getElementById('status');

    function log(msg) {
      logsEl.textContent += msg + '\n';
      logsEl.scrollTop = logsEl.scrollHeight;
    }

    document.getElementById('connectBtn').addEventListener('click', () => {
      const userId = document.getElementById('userId').value.trim();
      if (!userId) return alert('Vui lòng nhập userId của bạn');

      socket = io('http://localhost:8093', {
        transports: ['websocket'],
        query: { userId },
      });

      socket.on('connect', () => {
        statusEl.textContent = 'Connected';
        statusEl.style.color = 'green';
        log(`✅ Connected with socketId: ${socket.id}`);
      });

      socket.on('disconnect', () => {
        statusEl.textContent = 'Disconnected';
        statusEl.style.color = 'red';
        log(`❌ Disconnected`);
      });

      socket.on('receive_message', (msg) => {
        log(`💬 New message: ${JSON.stringify(msg)}`);
      });
    });

    document.getElementById('sendBtn').addEventListener('click', () => {
      const senderId = document.getElementById('userId').value.trim();
      const receiverId = document.getElementById('receiverId').value.trim();
      const content = document.getElementById('messageInput').value.trim();

      if (!socket || socket.disconnected) return alert('Chưa kết nối socket');
      if (!receiverId || !content) return alert('Thiếu thông tin');

      const payload = { 
        convId : "68eb3adaa035480aa3659564",
        content : content,
        senderId : senderId,
      };
      socket.emit('send_message', payload);
      log(`📤 Sent: ${JSON.stringify(payload)}`);
    });

    document.getElementById('disconnectBtn').addEventListener('click', () => {
      if (socket) {
        socket.disconnect();
        socket = null;
        statusEl.textContent = 'Disconnected';
        statusEl.style.color = 'red';
        log('🔌 Disconnected manually');
      }
    });
  </script>
</body>

</html>