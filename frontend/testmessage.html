<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Chat & React Test</title>
  <style>
    body { font-family: sans-serif; padding: 10px 20px; }
    h2, h3 { border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    div { margin-bottom: 15px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 5px; }
    label { display: inline-block; width: 100px; }
    input { width: 300px; padding: 5px; }
    button { padding: 5px 10px; cursor: pointer; }
    pre { background: #f5f5f5; padding: 10px; height: 300px; overflow: auto; border: 1px solid #ddd; }
  </style>
</head>

<body>
  <h2>ðŸ’¬ Chat & React Test</h2>

  <div>
    <h3>Connection</h3>
    <label>User ID:</label>
    <input id="userId" placeholder="Nháº­p userId cá»§a báº¡n" />
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn">Disconnect</button>
  </div>

  <div>
    <h3>Send Message</h3>
    <label>Conversation ID:</label>
    <input id="convId" placeholder="Nháº­p ID cuá»™c trÃ² chuyá»‡n" value="68eb3adaa035480aa3659564"/>
    <br>
    <label>Message:</label>
    <input id="messageInput" placeholder="Nháº­p tin nháº¯n..." />
    <button id="sendBtn">Send</button>
  </div>
  
  <div>
      <h3>React to Message</h3>
      <label>Message ID:</label>
      <input id="messageId" placeholder="Nháº­p ID tin nháº¯n cáº§n react"/>
      <br>
      <label>Icon:</label>
      <input id="iconInput" placeholder="Nháº­p icon, vd: ðŸ‘" value="ðŸ‘"/>
      <button id="reactBtn">React</button>
  </div>

  <h3>Status: <span id="status">Disconnected</span></h3>
  <h4>Logs:</h4>
  <pre id="logs"></pre>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    let socket;
    const logsEl = document.getElementById('logs');
    const statusEl = document.getElementById('status');

    function log(msg) {
      const timestamp = `[${new Date().toLocaleTimeString()}]`;
      logsEl.textContent += `${timestamp} ${msg}\n`;
      logsEl.scrollTop = logsEl.scrollHeight;
    }

    // --- CONNECTION ---
    document.getElementById('connectBtn').addEventListener('click', () => {
      const userId = document.getElementById('userId').value.trim();
      if (!userId) return alert('Vui lÃ²ng nháº­p userId cá»§a báº¡n');
      
      // Ngáº¯t káº¿t ná»‘i cÅ© náº¿u cÃ³
      if (socket) socket.disconnect();

      socket = io('http://localhost:8093', {
        transports: ['websocket'],
        query: { userId },
      });

      // Láº¯ng nghe cÃ¡c sá»± kiá»‡n tá»« server
      socket.on('connect', () => {
        statusEl.textContent = 'Connected';
        statusEl.style.color = 'green';
        log(`âœ… Connected with socketId: ${socket.id}`);
      });

      socket.on('disconnect', (reason) => {
        statusEl.textContent = 'Disconnected';
        statusEl.style.color = 'red';
        log(`âŒ Disconnected. Reason: ${reason}`);
      });

      // Sá»± kiá»‡n nháº­n tin nháº¯n má»›i
      socket.on('receive_message', (msg) => {
        log(`ðŸ’¬ IN: [receive_message] - ${JSON.stringify(msg, null, 2)}`);
      });

      // Sá»± kiá»‡n nháº­n reaction má»›i
      socket.on('message_reacted', (msg) => {
        log(`ðŸ’– IN: [message_reacted] - ${JSON.stringify(msg, null, 2)}`);
      });

      // Sá»± kiá»‡n xÃ¡c nháº­n reaction thÃ nh cÃ´ng
      socket.on('react_message_success', (data) => {
          log(`âœ… SUCCESS: [react_message_success] - ${JSON.stringify(data, null, 2)}`);
      });
      
      // Láº¯ng nghe lá»—i chung tá»« server
      socket.on('ws_error', (error) => {
          log(`ðŸ”¥ ERROR: [ws_error] on event '${error.event}'. Details: ${error.details}`);
      });
    });

    document.getElementById('disconnectBtn').addEventListener('click', () => {
      if (socket) {
        socket.disconnect();
      }
    });

    // --- SEND MESSAGE ---
    document.getElementById('sendBtn').addEventListener('click', () => {
      const senderId = document.getElementById('userId').value.trim();
      const convId = document.getElementById('convId').value.trim();
      const content = document.getElementById('messageInput').value.trim();

      if (!socket || socket.disconnected) return alert('ChÆ°a káº¿t ná»‘i socket');
      if (!convId || !content) return alert('Thiáº¿u thÃ´ng tin Conversation ID hoáº·c ná»™i dung tin nháº¯n');

      const payload = { 
        convId: convId,
        content: content,
        senderId: senderId,
      };
      socket.emit('send_message', payload);
      log(`ðŸ“¤ OUT: [send_message] - ${JSON.stringify(payload)}`);
    });

    // --- REACT MESSAGE ---
    document.getElementById('reactBtn').addEventListener('click', () => {
        const userId = document.getElementById('userId').value.trim();
        const messageId = document.getElementById('messageId').value.trim();
        const icon = document.getElementById('iconInput').value.trim();
        
        if (!socket || socket.disconnected) return alert('ChÆ°a káº¿t ná»‘i socket');
        if (!userId || !messageId || !icon) return alert('Thiáº¿u User ID, Message ID hoáº·c Icon');

        const payload = {
            convId : "68eb3adaa035480aa3659564",
            messageId: messageId,
            react: {
                userId: userId,
                reactType: Number.parseInt(icon),
            }
        };
        socket.emit('react_message', payload);
        log(`ðŸ“¤ OUT: [react_message] - ${JSON.stringify(payload)}`);
    });

  </script>
</body>

</html>